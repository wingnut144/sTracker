<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intimate Moments - Calendar</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Cormorant:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #d4a5a5;
            --secondary: #9c7a7a;
            --accent: #c98686;
            --bg: #faf8f6;
            --surface: #ffffff;
            --text: #4a3838;
            --text-light: #8b7373;
            --shadow: rgba(138, 90, 90, 0.12);
            --border: rgba(212, 165, 165, 0.2);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cormorant', serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px var(--shadow);
        }
        
        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: -0.5px;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 8px;
            font-family: 'Cormorant', serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: white;
            color: var(--secondary);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: var(--surface);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px var(--shadow);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--secondary);
            font-family: 'Playfair Display', serif;
        }
        
        .stat-label {
            color: var(--text-light);
            font-size: 1.1rem;
            margin-top: 5px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: var(--surface);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px var(--shadow);
        }
        
        .month-nav {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .nav-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3rem;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover {
            transform: scale(1.1);
            background: var(--accent);
        }
        
        .current-month {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--secondary);
            min-width: 250px;
            text-align: center;
        }
        
        .add-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'Cormorant', serif;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 165, 165, 0.4);
        }
        
        .calendar {
            background: var(--surface);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px var(--shadow);
        }
        
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .weekday {
            text-align: center;
            font-weight: 500;
            color: var(--secondary);
            font-size: 1.1rem;
            padding: 10px;
        }
        
        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }
        
        .day {
            aspect-ratio: 1;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .day:hover {
            background: rgba(212, 165, 165, 0.05);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .day.other-month {
            color: var(--text-light);
            opacity: 0.4;
        }
        
        .day.today {
            border-color: var(--accent);
            background: rgba(201, 134, 134, 0.05);
        }
        
        .day-number {
            font-size: 1.1rem;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .day-encounters {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: auto;
        }
        
        .encounter-icon {
            font-size: 1.3rem;
            transition: transform 0.2s ease;
            display: inline-block;
            width: 24px;
            height: 24px;
        }
        
        .encounter-icon:hover {
            transform: scale(1.2);
        }
        
        .position-svg {
            width: 100%;
            height: 100%;
            fill: var(--secondary);
            stroke: none;
        }
        
        .position-icon-large .position-svg {
            fill: var(--primary);
        }
        
        .position-option.selected .position-svg {
            fill: var(--accent);
        }
        
        .position-option:hover .position-svg {
            fill: var(--accent);
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(74, 56, 56, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: var(--surface);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .modal-header h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: var(--secondary);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-light);
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .close-btn:hover {
            color: var(--secondary);
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--secondary);
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-family: 'Cormorant', serif;
            font-size: 1.1rem;
            background: var(--bg);
            color: var(--text);
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--surface);
            box-shadow: 0 0 0 4px rgba(212, 165, 165, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .position-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .position-option {
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .position-option:hover {
            border-color: var(--primary);
            background: rgba(212, 165, 165, 0.05);
        }
        
        .position-option.selected {
            border-color: var(--accent);
            background: rgba(201, 134, 134, 0.1);
        }
        
        .position-icon-large {
            font-size: 2rem;
            display: block;
            margin-bottom: 5px;
            width: 60px;
            height: 60px;
            margin: 0 auto 10px;
        }
        
        .position-name {
            font-size: 1rem;
            color: var(--text-light);
        }
        
        .rating-stars {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        
        .star {
            font-size: 2rem;
            cursor: pointer;
            color: var(--border);
            transition: all 0.2s ease;
        }
        
        .star.filled {
            color: #f4c542;
        }
        
        .star:hover {
            transform: scale(1.2);
        }
        
        .submit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'Cormorant', serif;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 165, 165, 0.4);
        }
        
        /* Comments Section */
        .comments-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid var(--border);
        }
        
        .comments-header {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--secondary);
            margin-bottom: 20px;
        }
        
        .comment {
            background: var(--bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .comment-user {
            font-weight: 600;
            color: var(--secondary);
        }
        
        .comment-time {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        .comment-rating {
            color: #f4c542;
            margin: 5px 0;
        }
        
        .comment-text {
            margin: 10px 0;
        }
        
        .comment-suggestions {
            margin-top: 10px;
            padding: 10px;
            background: rgba(212, 165, 165, 0.05);
            border-left: 3px solid var(--primary);
            border-radius: 5px;
            font-style: italic;
        }
        
        .delete-btn {
            padding: 10px 20px;
            background: #c94d4d;
            color: white;
            border: none;
            border-radius: 8px;
            font-family: 'Cormorant', serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .delete-btn:hover {
            background: #a93d3d;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Intimate Moments</h1>
        <div class="header-actions">
            <a href="/profile" class="btn" id="profile-btn">
                <span id="notification-badge" style="display: none; background: #ff4444; color: white; border-radius: 50%; padding: 2px 8px; font-size: 0.9rem; margin-right: 5px;"></span>
                üë§ Profile
            </a>
            <a href="/admin" class="btn">‚öôÔ∏è Manage Icons</a>
            <button class="btn" onclick="window.location.href='/logout'">Sign Out</button>
        </div>
    </div>
    
    <div class="container">
        <div class="stats-bar" id="stats">
            <!-- Stats will be loaded here -->
        </div>
        
        <div class="calendar-header">
            <div class="month-nav">
                <button class="nav-btn" onclick="previousMonth()">‚Üê</button>
                <div class="current-month" id="current-month"></div>
                <button class="nav-btn" onclick="nextMonth()">‚Üí</button>
            </div>
            <button class="add-btn" onclick="openAddModal()">+ Add Encounter</button>
        </div>
        
        <div class="calendar">
            <div class="weekdays">
                <div class="weekday">Sun</div>
                <div class="weekday">Mon</div>
                <div class="weekday">Tue</div>
                <div class="weekday">Wed</div>
                <div class="weekday">Thu</div>
                <div class="weekday">Fri</div>
                <div class="weekday">Sat</div>
            </div>
            <div class="days" id="calendar-days"></div>
        </div>
    </div>
    
    <!-- Add Encounter Modal -->
    <div class="modal" id="add-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Encounter</h2>
                <button class="close-btn" onclick="closeModal('add-modal')">&times;</button>
            </div>
            <form onsubmit="handleAddEncounter(event)">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="encounter-date" required>
                </div>
                <div class="form-group">
                    <label>Time (optional)</label>
                    <input type="time" id="encounter-time">
                </div>
                <div class="form-group">
                    <label>Position</label>
                    <div class="position-grid" id="position-grid">
                        {% for key, value in positions.items() %}
                        <div class="position-option" onclick="selectPosition('{{ key }}')">
                            <span class="position-icon-large" id="icon-{{ key }}"></span>
                            <div class="position-name">{{ value.name }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    <input type="hidden" id="selected-position" required>
                </div>
                <div class="form-group">
                    <label>Duration (minutes)</label>
                    <input type="number" id="encounter-duration" min="1">
                </div>
                <div class="form-group">
                    <label>Rating</label>
                    <div class="rating-stars" id="add-rating">
                        <span class="star" onclick="setRating('add', 1)">‚òÜ</span>
                        <span class="star" onclick="setRating('add', 2)">‚òÜ</span>
                        <span class="star" onclick="setRating('add', 3)">‚òÜ</span>
                        <span class="star" onclick="setRating('add', 4)">‚òÜ</span>
                        <span class="star" onclick="setRating('add', 5)">‚òÜ</span>
                    </div>
                    <input type="hidden" id="encounter-rating">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="encounter-notes"></textarea>
                </div>
                <button type="submit" class="submit-btn">Add Encounter</button>
            </form>
        </div>
    </div>
    
    <!-- View Encounter Modal -->
    <div class="modal" id="view-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Encounter Details</h2>
                <button class="close-btn" onclick="closeModal('view-modal')">&times;</button>
            </div>
            <div id="encounter-details"></div>
            
            <div class="comments-section">
                <h3 class="comments-header">Comments & Feedback</h3>
                <div id="comments-list"></div>
                
                <form onsubmit="handleAddComment(event)" style="margin-top: 20px;">
                    <div class="form-group">
                        <label>Add Comment</label>
                        <textarea id="comment-text" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Rating</label>
                        <div class="rating-stars" id="comment-rating">
                            <span class="star" onclick="setRating('comment', 1)">‚òÜ</span>
                            <span class="star" onclick="setRating('comment', 2)">‚òÜ</span>
                            <span class="star" onclick="setRating('comment', 3)">‚òÜ</span>
                            <span class="star" onclick="setRating('comment', 4)">‚òÜ</span>
                            <span class="star" onclick="setRating('comment', 5)">‚òÜ</span>
                        </div>
                        <input type="hidden" id="comment-rating-value">
                    </div>
                    <div class="form-group">
                        <label>Suggestions (optional)</label>
                        <textarea id="comment-suggestions"></textarea>
                    </div>
                    <button type="submit" class="submit-btn">Add Comment</button>
                </form>
            </div>
            
            <button class="delete-btn" onclick="deleteEncounter()">Delete Encounter</button>
        </div>
    </div>
    
    <script>
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let encounters = [];
        let currentEncounterId = null;
        
        const positions = {{ positions | tojson }};
        
        // Default SVG silhouettes
        const defaultSVGs = {
            missionary: '<svg viewBox="0 0 100 100" class="position-svg"><ellipse cx="50" cy="22" rx="7" ry="8"/><path d="M43 30 Q43 28 45 28 L55 28 Q57 28 57 30 L58 42 Q58 45 56 47 L54 58 Q53 62 50 62 Q47 62 46 58 L44 47 Q42 45 42 42 Z M42 42 L35 48 Q33 50 33 52 L33 58 M58 42 L65 48 Q67 50 67 52 L67 58"/><ellipse cx="32" cy="65" rx="5" ry="6"/><path d="M27 71 Q27 69 29 69 L35 69 Q37 69 37 71 L37 78 Q37 80 36 82 L35 88 Q34 91 32 91 Q30 91 29 88 L28 82 Q27 80 27 78 Z M27 78 L22 84 M37 78 L42 84"/><ellipse cx="68" cy="65" rx="5" ry="6"/><path d="M63 71 Q63 69 65 69 L71 69 Q73 69 73 71 L73 78 Q73 80 72 82 L71 88 Q70 91 68 91 Q66 91 65 88 L64 82 Q63 80 63 78 Z M63 78 L58 84 M73 78 L78 84"/></svg>',
            doggy: '<svg viewBox="0 0 100 100" class="position-svg"><ellipse cx="30" cy="42" rx="6" ry="7"/><path d="M24 49 Q24 47 26 47 L34 47 Q36 47 36 49 L36 58 Q36 60 35 62 L34 70 Q33 73 30 73 Q27 73 26 70 L25 62 Q24 60 24 58 Z M24 58 L18 64 Q16 66 16 68 L16 72 M36 58 L42 64 Q44 66 44 68 L44 72 M25 70 L22 80 M35 70 L32 80"/><ellipse cx="65" cy="28" rx="6" ry="7"/><path d="M59 35 Q59 33 61 33 L69 33 Q71 33 71 35 L72 48 Q72 51 70 53 L69 63 Q68 67 65 67 Q62 67 61 63 L60 53 Q58 51 58 48 Z M58 48 L52 55 Q50 57 50 59 L50 64 M72 48 L78 55 Q80 57 80 59 L80 64 M60 63 L57 76 M70 63 L73 76"/></svg>',
            cowgirl: '<svg viewBox="0 0 100 100" class="position-svg"><ellipse cx="50" cy="15" rx="6" ry="7"/><path d="M44 22 Q44 20 46 20 L54 20 Q56 20 56 22 L57 35 Q57 38 55 40 L54 50 Q53 54 50 54 Q47 54 46 50 L45 40 Q43 38 43 35 Z M43 35 L37 41 Q35 43 35 45 L35 50 M57 35 L63 41 Q65 43 65 45 L65 50 M45 50 L42 62 Q41 65 41 67 L41 70 M55 50 L58 62 Q59 65 59 67 L59 70"/><ellipse cx="50" cy="70" rx="5" ry="6"/><path d="M45 76 Q45 74 47 74 L53 74 Q55 74 55 76 L55 83 Q55 85 54 87 L53 92 Q52 95 50 95 Q48 95 47 92 L46 87 Q45 85 45 83 Z M45 83 L40 88 M55 83 L60 88"/></svg>',
            reverse_cowgirl: '<svg viewBox="0 0 100 100" class="position-svg"><ellipse cx="50" cy="15" rx="6" ry="7"/><path d="M44 22 Q44 20 46 20 L54 20 Q56 20 56 22 L57 35 Q57 38 55 40 L54 50 Q53 54 50 54 Q47 54 46 50 L45 40 Q43 38 43 35 Z M43 35 L37 41 Q35 43 35 45 L35 50 M57 35 L63 41 Q65 43 65 45 L65 50 M45 50 L41 62 Q40 65 40 67 L40 70 M55 50 L59 62 Q60 65 60 67 L60 70"/><ellipse cx="50" cy="74" rx="5" ry="6"/><path d="M45 80 Q45 78 47 78 L53 78 Q55 78 55 80 L55 87 Q55 89 54 91 L53 95 Q52 98 50 98 Q48 98 47 95 L46 91 Q45 89 45 87 Z"/></svg>',
            spooning: '<svg viewBox="0 0 100 100" class="position-svg"><ellipse cx="32" cy="36" rx="5" ry="6"/><path d="M27 42 Q27 40 29 40 L35 40 Q37 40 37 42 L37 52 Q37 54 36 56 L35 65 Q34 68 32 68 Q30 68 29 65 L28 56 Q27 54 27 52 Z M27 52 L22 58 Q20 60 20 62 L20 66 M37 52 L42 58 Q44 60 44 62 L44 66 M28 65 L24 76 M36 65 L32 76"/><ellipse cx="58" cy="40" rx="5" ry="6"/><path d="M53 46 Q53 44 55 44 L61 44 Q63 44 63 46 L63 56 Q63 58 62 60 L61 69 Q60 72 58 72 Q56 72 55 69 L54 60 Q53 58 53 56 Z M53 56 L48 62 Q46 64 46 66 L46 70 M63 56 L68 62 Q70 64 70 66 L70 70 M54 69 L50 80 M62 69 L58 80"/></svg>',
            standing: '<svg viewBox="0 0 100 100" class="position-svg"><ellipse cx="35" cy="18" rx="5" ry="6"/><path d="M30 24 Q30 22 32 22 L38 22 Q40 22 40 24 L40 34 Q40 36 39 38 L38 50 Q37 53 35 53 Q33 53 32 50 L31 38 Q30 36 30 34 Z M30 34 L25 40 Q23 42 23 44 L23 48 M40 34 L45 40 Q47 42 47 44 L47 48 M31 50 L28 68 Q27 72 27 74 L27 78 M39 50 L42 68 Q43 72 43 74 L43 78"/><ellipse cx="62" cy="22" rx="5" ry="6"/><path d="M57 28 Q57 26 59 26 L65 26 Q67 26 67 28 L67 38 Q67 40 66 42 L65 54 Q64 57 62 57 Q60 57 59 54 L58 42 Q57 40 57 38 Z M57 38 L52 44 Q50 46 50 48 L50 52 M67 38 L72 44 Q74 46 74 48 L74 52 M58 54 L55 72 Q54 76 54 78 L54 82 M66 54 L69 72 Q70 76 70 78 L70 82"/></svg>',
            oral: '<svg viewBox="0 0 100 100" class="position-svg"><ellipse cx="50" cy="22" rx="6" ry="7"/><path d="M44 29 Q44 27 46 27 L54 27 Q56 27 56 29 L57 42 Q57 45 55 47 L54 57 Q53 61 50 61 Q47 61 46 57 L45 47 Q43 45 43 42 Z M43 42 L37 48 Q35 50 35 52 L35 57 M57 42 L63 48 Q65 50 65 52 L65 57 M45 57 L41 69 Q40 72 40 74 L40 77 M55 57 L59 69 Q60 72 60 74 L60 77"/><ellipse cx="50" cy="68" rx="5" ry="6"/><path d="M45 74 Q45 72 47 72 L53 72 Q55 72 55 74 L55 82 Q55 84 54 86 L53 90 Q52 93 50 93 Q48 93 47 90 L46 86 Q45 84 45 82 Z"/></svg>',
            anal: '<svg viewBox="0 0 100 100" class="position-svg"><ellipse cx="32" cy="38" rx="5" ry="6"/><path d="M27 44 Q27 42 29 42 L35 42 Q37 42 37 44 L37 54 Q37 56 36 58 L35 67 Q34 70 32 70 Q30 70 29 67 L28 58 Q27 56 27 54 Z M27 54 L21 60 Q19 62 19 64 L19 68 M37 54 L43 60 Q45 62 45 64 L45 68 M28 67 L24 78 M36 67 L32 78"/><ellipse cx="65" cy="32" rx="6" ry="7"/><path d="M59 39 Q59 37 61 37 L69 37 Q71 37 71 39 L72 52 Q72 55 70 57 L69 67 Q68 71 65 71 Q62 71 61 67 L60 57 Q58 55 58 52 Z M58 52 L52 59 Q50 61 50 63 L50 68 M72 52 L78 59 Q80 61 80 63 L80 68 M60 67 L56 80 M70 67 L74 80"/></svg>',
            other: '<svg viewBox="0 0 100 100" class="position-svg"><ellipse cx="50" cy="28" rx="7" ry="8"/><path d="M43 36 Q43 34 45 34 L55 34 Q57 34 57 36 L58 50 Q58 53 56 55 L55 66 Q54 70 50 70 Q46 70 45 66 L44 55 Q42 53 42 50 Z M42 50 L35 57 Q33 59 33 61 L33 66 M58 50 L65 57 Q67 59 67 61 L67 66 M44 66 L39 80 M56 66 L61 80"/></svg>'
        };
        
        // Will be populated with custom icons from database
        let customIcons = {};
        
        // Load custom icons from database
        async function loadCustomIcons() {
            try {
                const response = await fetch('/api/custom-icons');
                if (response.ok) {
                    customIcons = await response.json();
                }
            } catch (error) {
                console.error('Error loading custom icons:', error);
            }
        }
        
        function getPositionIcon(position) {
            // Use custom icon if available, otherwise use default
            return customIcons[position] || defaultSVGs[position] || defaultSVGs.other;
        }
        
        async function loadEncounters() {
            const response = await fetch(`/api/encounters?month=${currentMonth + 1}&year=${currentYear}`);
            encounters = await response.json();
            renderCalendar();
        }
        
        async function loadStats() {
            const response = await fetch('/api/stats');
            const stats = await response.json();
            
            document.getElementById('stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total_encounters}</div>
                    <div class="stat-label">Total Encounters</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.this_month}</div>
                    <div class="stat-label">This Month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.average_rating.toFixed(1)}</div>
                    <div class="stat-label">Avg Rating</div>
                </div>
            `;
        }
        
        function renderCalendar() {
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();
            
            document.getElementById('current-month').textContent = 
                new Date(currentYear, currentMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const calendarDays = document.getElementById('calendar-days');
            calendarDays.innerHTML = '';
            
            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                calendarDays.innerHTML += `<div class="day other-month"><div class="day-number">${day}</div></div>`;
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateStr = date.toISOString().split('T')[0];
                const dayEncounters = encounters.filter(e => e.date === dateStr);
                
                const isToday = date.toDateString() === new Date().toDateString();
                
                const icons = dayEncounters.map(e => 
                    `<span class="encounter-icon" title="${e.position_name}">${getPositionIcon(e.position)}</span>`
                ).join('');
                
                calendarDays.innerHTML += `
                    <div class="day ${isToday ? 'today' : ''}" onclick="openDayModal('${dateStr}')">
                        <div class="day-number">${day}</div>
                        <div class="day-encounters">${icons}</div>
                    </div>
                `;
            }
            
            // Next month days
            const remainingDays = 42 - (firstDay + daysInMonth);
            for (let day = 1; day <= remainingDays; day++) {
                calendarDays.innerHTML += `<div class="day other-month"><div class="day-number">${day}</div></div>`;
            }
        }
        
        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            loadEncounters();
        }
        
        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            loadEncounters();
        }
        
        function openAddModal() {
            document.getElementById('encounter-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('add-modal').classList.add('show');
        }
        
        function openDayModal(dateStr) {
            const dayEncounters = encounters.filter(e => e.date === dateStr);
            
            if (dayEncounters.length === 0) {
                document.getElementById('encounter-date').value = dateStr;
                openAddModal();
            } else if (dayEncounters.length === 1) {
                viewEncounter(dayEncounters[0].id);
            } else {
                // Multiple encounters - show first one for now
                viewEncounter(dayEncounters[0].id);
            }
        }
        
        async function viewEncounter(id) {
            currentEncounterId = id;
            const response = await fetch(`/api/encounters/${id}`);
            const encounter = await response.json();
            
            document.getElementById('encounter-details').innerHTML = `
                <div class="form-group">
                    <label>Date</label>
                    <p>${new Date(encounter.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
                ${encounter.time ? `<div class="form-group"><label>Time</label><p>${encounter.time}</p></div>` : ''}
                <div class="form-group">
                    <label>Position</label>
                    <p><span class="encounter-icon">${getPositionIcon(encounter.position)}</span> ${encounter.position_name}</p>
                </div>
                ${encounter.duration ? `<div class="form-group"><label>Duration</label><p>${encounter.duration} minutes</p></div>` : ''}
                ${encounter.rating ? `<div class="form-group"><label>Rating</label><p>${'‚òÖ'.repeat(encounter.rating)}${'‚òÜ'.repeat(5 - encounter.rating)}</p></div>` : ''}
                ${encounter.notes ? `<div class="form-group"><label>Notes</label><p>${encounter.notes}</p></div>` : ''}
            `;
            
            const commentsList = document.getElementById('comments-list');
            if (encounter.comments.length > 0) {
                commentsList.innerHTML = encounter.comments.map(c => `
                    <div class="comment">
                        <div class="comment-header">
                            <span class="comment-user">${c.user}</span>
                            <span class="comment-time">${new Date(c.created_at).toLocaleString()}</span>
                        </div>
                        ${c.rating ? `<div class="comment-rating">${'‚òÖ'.repeat(c.rating)}${'‚òÜ'.repeat(5 - c.rating)}</div>` : ''}
                        <div class="comment-text">${c.text}</div>
                        ${c.suggestions ? `<div class="comment-suggestions">üí° ${c.suggestions}</div>` : ''}
                    </div>
                `).join('');
            } else {
                commentsList.innerHTML = '<p style="color: var(--text-light); font-style: italic;">No comments yet</p>';
            }
            
            document.getElementById('view-modal').classList.add('show');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            // Reset forms
            document.querySelectorAll('.position-option').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.star').forEach(el => el.classList.remove('filled'));
        }
        
        function selectPosition(position) {
            document.querySelectorAll('.position-option').forEach(el => el.classList.remove('selected'));
            event.target.closest('.position-option').classList.add('selected');
            document.getElementById('selected-position').value = position;
        }
        
        function setRating(type, rating) {
            const container = document.getElementById(`${type}-rating`);
            const stars = container.querySelectorAll('.star');
            
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('filled');
                    star.textContent = '‚òÖ';
                } else {
                    star.classList.remove('filled');
                    star.textContent = '‚òÜ';
                }
            });
            
            if (type === 'add') {
                document.getElementById('encounter-rating').value = rating;
            } else {
                document.getElementById('comment-rating-value').value = rating;
            }
        }
        
        async function handleAddEncounter(e) {
            e.preventDefault();
            
            const data = {
                date: document.getElementById('encounter-date').value,
                time: document.getElementById('encounter-time').value,
                position: document.getElementById('selected-position').value,
                duration: document.getElementById('encounter-duration').value,
                rating: document.getElementById('encounter-rating').value,
                notes: document.getElementById('encounter-notes').value
            };
            
            const response = await fetch('/api/encounters', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                closeModal('add-modal');
                loadEncounters();
                loadStats();
                e.target.reset();
            }
        }
        
        async function handleAddComment(e) {
            e.preventDefault();
            
            const data = {
                text: document.getElementById('comment-text').value,
                rating: document.getElementById('comment-rating-value').value,
                suggestions: document.getElementById('comment-suggestions').value
            };
            
            const response = await fetch(`/api/encounters/${currentEncounterId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                viewEncounter(currentEncounterId);
                e.target.reset();
                document.querySelectorAll('#comment-rating .star').forEach(el => {
                    el.classList.remove('filled');
                    el.textContent = '‚òÜ';
                });
            }
        }
        
        async function deleteEncounter() {
            if (!confirm('Are you sure you want to delete this encounter?')) return;
            
            const response = await fetch(`/api/encounters/${currentEncounterId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                closeModal('view-modal');
                loadEncounters();
                loadStats();
            }
        }
        
        // Initialize
        // Populate position icons with defaults first
        Object.keys(defaultSVGs).forEach(position => {
            const iconElement = document.getElementById(`icon-${position}`);
            if (iconElement) {
                iconElement.innerHTML = defaultSVGs[position];
            }
        });
        
        // Load custom icons, then load encounters
        loadCustomIcons().then(() => {
            // Update icons with custom ones if they exist
            Object.keys(defaultSVGs).forEach(position => {
                const iconElement = document.getElementById(`icon-${position}`);
                if (iconElement) {
                    iconElement.innerHTML = getPositionIcon(position);
                }
            });
            loadEncounters();
            loadStats();
            checkNotifications();
        });
        
        // Check for unread notifications
        async function checkNotifications() {
            try {
                const response = await fetch('/api/notifications/unread_count');
                const data = await response.json();
                
                if (data.count > 0) {
                    const badge = document.getElementById('notification-badge');
                    badge.textContent = data.count;
                    badge.style.display = 'inline-block';
                }
            } catch (error) {
                console.error('Error checking notifications');
            }
        }
        
        // Poll for notifications every 30 seconds
        setInterval(checkNotifications, 30000);
    </script>
</body>
</html>
